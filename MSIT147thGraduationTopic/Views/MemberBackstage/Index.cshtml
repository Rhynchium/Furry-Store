@{
    Layout = "_BackstagePage";
    ViewData["Title"] = "會員管理系統";
}

<header class="container px-5 mt-5">

    <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">會員管理</li>
            <li class="breadcrumb-item active" aria-current="page">會員檢視</li>
        </ol>
    </nav>
</header>

<div class="container px-5">
    <div class="row gx-5">
        <div class="col-xl-9 col-lg-6">
            <div class="contentbox bg-light rounded shadow p-2 mb-5">
                <div class="p-4">
                    <h2>會員檢視</h2>
                    <div class="d-flex">
                        <input type="text" id="query" name="query">
                        <button type="button" id="btnQuery">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </button>
                    </div>
                </div>
                <div class="tablebox">
                    <table class="table table-light table-striped table-hover">
                        <thead>
                            <tr>                                
                                <th>姓名</th>
                                <th>帳號名稱</th>
                                <th>權限</th>                                
                                <th style="width:5rem" class="text-center">權限調整</th>                                
                                <th style="width:3rem" class="text-center"></th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-lg-6">
            <div class="bg-light rounded shadow p-2 mb-5" id="data">
                <table class="table">
                    <thead>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-nowrap">姓名</td>
                            <td id="displayName"></td>
                        </tr>
                        <tr>
                            <td class="text-nowrap">帳號名稱</td>
                            <td id="displayAccount"></td>
                        </tr>
                        <tr>
                            <td class="text-nowrap">性別</td>
                            <td id="displayGender"></td>
                        </tr>
                        <tr>
                            <td class="text-nowrap">縣市</td>
                            <td id="displayCity"></td>
                        </tr>
                        <tr>
                            <td class="text-nowrap">區域</td>
                            <td id="displayDistrict"></td>
                        </tr>
                        <tr>
                            <td class="text-nowrap">地址</td>
                            <td id="displayAddress"></td>
                        </tr>
                        <tr>
                            <td class="text-nowrap">電話</td>
                            <td id="displayPhone"></td>
                        </tr>
                        <tr>
                            <td class="text-nowrap">Email</td>
                            <td id="displayEmail"></td>
                        </tr>
                        <tr>
                            <td class="text-nowrap">權限</td>
                            <td id="displayIsActived"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts{
   <script>
        //會員資料
        let memberData
        //抓取會員資料
        getMembers()
        //搜尋按鈕
        $('#btnQuery').click(e => getEmployees($('#query').val()))
        //修改權限按鈕
        $('#btnChangePermission').click(submitChangePermission)

        //Ajax 得到會員資料
        async function getMembers(query) {
            //showLoadingBox()
            let str = ''
            if (query) str = '/' + query
            const response = await fetch('@Url.Content("~/api/apimember")' + str)

            if (!response.ok) return
            const data = await response.json()

            memberData = data
            displayMembers()
            //hideLoadingBox()
        }

        //Ajax 修改會員權限
        async function submitChangePermission() {
            
            const confirm = await confirmWithPassword()
            if (!confirm) return

            const permission = $('#').val()
            const id = $('#').attr('data-memberId')

            //showLoadingBox()
            const response = await fetch(`@Url.Content("~/api/apimember/permission")/${id}`, {
                body: JSON.stringify({ 'permission': permission }),
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', },
            })

            if (response.status == 400) {
                console.log("輸入格式錯誤")
            }

            if (response.ok) {
                const data = await response.json()
                console.log(data)
                getMembers()                
                await Swal.fire(
                    '修改成功!',
                    '會員權限已修改!',
                    'success'
                )
            }
            //hideLoadingBox()
        }

        //列出會員
        function displayMembers() {
            const trs = memberData.map((element, index) => {                
                return `<tr data-index="${index}" >                    
                    <td>${element.memberName}</td>
                    <td>${element.account}</td>
                    <td>${element.permission}</td>                    
                    <td class="text-center">
                    <button class="btn btn-danger permission-btn"><i class="fa-solid fa-pen-nib"></i></button>
                    </td>
                    </tr>`
            })
            $('.tablebox').find('tbody').html(trs.join(''))
            $('.tablebox').find('.permission-btn').click()
            $('.tablebox').find('tbody').find('tr').click(displayMemberDataInRow)
            displayMemberData(0)
        }

        //顯示點選tr的會員資料
        function displayMemberDataInRow(event) {
            const index = +event.currentTarget.dataset.index
            displayMemberData(index)
        }

        //顯示第n筆會員資料
        function displayMemberData(index) {
            if (!memberData.length) return           

            $('#displayName').text(memberData[index].memberName)
            $('#displayGender').text(memberData[index].gender)
            $('#displayAccount').text(memberData[index].account)
            $('#displayPhone').text(memberData[index].phone)
            $('#displayEmail').text(memberData[index].email)
            $('#displayCity').text(memberData[index].city)
            $('#displayDistrict').text(memberData[index].district)
            $('#displayAddress').text(memberData[index].address)
            $('#displayPermission').text(memberData[index].isActived)
        }

        //彈出修改權限
        async function showEditPermissionModal(event) {
            if (!await validateRole('管理員')) return;

            const index = +$(event.currentTarget).closest('tr').attr('data-index')
            $('#selectPermission').val(memberData[index].permission)
                .attr('data-memberId', memberData[index].memberId)
            
        }
   </script>
}

@section Styles{
    <style>
        .contentbox {
            height: 720px;
            overflow: auto;
        }

        .tablebox {
            height: 500px;
            overflow: auto;
        }

            .tablebox td img {
                height: 50px;
            }

            .tablebox td, th {
                vertical-align: middle;
            }
    </style>
}