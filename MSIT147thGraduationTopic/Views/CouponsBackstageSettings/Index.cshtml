@using MSIT147thGraduationTopic.Models.Dtos
@model (IEnumerable<CouponDto> listDiscount,IEnumerable<CouponDto> listRebate)
@{
    Layout = "_BackstagePage";
    ViewData["Title"] = "優惠券管理系統";
}

<body class="d-flex flex-column h-100">
    <main class="flex-shrink-0">
        <!-- Page Content-->
        <section class="py-5">
            <div class="text-center mb-5">
                <h1 class="fw-bolder">優惠券管理系統</h1>
                <p class="lead fw-normal text-muted mb-0"></p>
            </div>
            <div class="container px-5 my-5">
                <label for="CouponId">打折券ID搜尋</label>
                <input type="text" id="txtDiscountIdSearch" name="txtDiscountIdSearch" placeholder="請輸入ID" />
                <label for="CouponName">打折優惠券名稱關鍵字</label>
                <input type="text" id="txtDiscountNameSearch" name="txtDiscountNameSearch" placeholder="請輸入名稱關鍵字" />
                <button type="submit" class="btn btn-primary" id="btnDiscountSearch" disabled>搜尋</button>
            </div>
            <div class="container px-5 my-5">
                <h2 class="text-center">折價優惠券</h2>
                <table class="table table-dark table-hover" id="tabDiscount">
                    <thead>
                        <tr>
                            <th scope="col">序號</th>
                            <th scope="col">優惠券名稱</th>
                            <th scope="col">適用對象</th>
                            <th scope="col">活動開始日期</th>
                            <th scope="col">活動結束日期</th>
                            <th scope="col">打折優惠</th>
                            <th scope="col">修改</th>
                            <th scope="col">刪除</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            foreach (CouponDto c in Model.listDiscount)
                            {
                                <tr>
                                    <td id="DiscountId" scope="col">@c.CouponId</td>
                                    <td id="DiscountName" scope="col">@c.CouponName</td>
                                    <td id="DiscountTagId" scope="col">@c.CouponTagId</td>
                                    <td id="DiscountStartDate" scope="col">@c.CouponStartDate</td>
                                    <td id="DiscountEndDate" scope="col">@c.CouponEndDate</td>
                                    <td id="DiscountValue" scope="col">@c.CouponDiscount.ToString("#.##"+"折")</td>
                                    <td id="Discount" scope="col">
                                        <button type="button" id="btnEditDiscont_@c.CouponId" class="btn btn-success btnEditDiscont">
                                            修改
                                        </button>
                                    </td>
                                    <td scope="col">
                                        <button type="button" id="btnDelete_@c.CouponId" class="btn btn-danger btnDelete">
                                            刪除
                                        </button>
                                    </td>
                                </tr>
                            }

                        }
                    </tbody>
                </table>
            </div>
            <div class="container px-5 my-5">
                <label for="CouponId">滿額送ID搜尋</label>
                <input type="text" id="txtRebateIdSearch" name="txtRebateIdSearch" placeholder="請輸入ID" />
                <label for="CouponName">滿額送優惠券名稱關鍵字</label>
                <input type="text" id="txtRebateNameSearch" name="txtRebateNameSearch" placeholder="請輸入名稱關鍵字" />
                <button type="submit" class="btn btn-primary" id="btnRebateSearch" disabled>搜尋</button>
            </div>
            <div class="container px-5 my-5">
                <h2 class="text-center">滿額送優惠券</h2>
                <form id="listOfRebate" name="listOfRebate" data-index="-1" class="needs-validation" novalidate>
                    <table class="table table-dark table-hover" id="tabRebate">
                        <thead>
                            <tr>
                                <th scope="col">序號</th>
                                <th scope="col">優惠券名稱</th>
                                <th scope="col">適用對象</th>
                                <th scope="col">活動開始日期</th>
                                <th scope="col">活動結束日期</th>
                                <th scope="col">額度門檻</th>
                                <th scope="col">折扣金額</th>
                                <th scope="col">修改</th>
                                <th scope="col">刪除</th>
                            </tr>
                        </thead>

                        <tbody>
                            @{
                                foreach (CouponDto c in Model.listRebate)
                                {
                                    <tr>
                                        <td id="RebateId" scope="col">@c.CouponId</td>
                                        <td id="RebateName" scope="col">@c.CouponName</td>
                                        <td id="RebateTagId" scope="col">@c.CouponTagId</td>
                                        <td id="RebateStartDate" scope="col">@c.CouponStartDate</td>
                                        <td id="RebateEndDate" scope="col">@c.CouponEndDate</td>
                                        <td id="RebateCondition" scope="col">@c.CouponCondition.GetValueOrDefault().ToString("#.##")</td>
                                        <td id="RebateDiscount" scope="col">@c.CouponDiscount.ToString("#.##")</td>
                                        <td scope="col">
                                            <button type="button" id="btnEditRebate_@c.CouponId" class="btn btn-success btnEditRebate">
                                                修改
                                            </button>
                                        </td>
                                        <td scope="col">
                                            <button type="button" id="btnDelete_@c.CouponId" class="btn btn-danger btnDelete">
                                                刪除
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </form>
            </div>
            <div class="container px-5 my-5 text-center">
                <button class="btn btn-primary" id="btnCreate">新增</button>
                <button type="submit" class="btn btn-success btnClear" id="btnClear">清空</button>
            </div>
        </section>
        <section class="py-5 bg-light">
        </section>
        <section class="py-5 bg-light">
            <div class="container px-5 my-5">
                <div class="row">
                    <div class="col">
                        <span class="text-muted">目前資料筆數:0/0</span>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <!-- Footer-->
    <footer class="bg-dark py-4 mt-auto">
        <div class="container px-5">
            <div class="row align-items-center justify-content-between flex-column flex-sm-row">
                <div class="col-auto"><div class="small m-0 text-white">Copyright &copy; Your Website 2023</div></div>
                <div class="col-auto">
                    <a class="link-light small" href="#!">Privacy</a>
                    <span class="text-white mx-1">&middot;</span>
                    <a class="link-light small" href="#!">Terms</a>
                    <span class="text-white mx-1">&middot;</span>
                    <a class="link-light small" href="#!">Contact</a>
                </div>
            </div>
        </div>
    </footer>
</body>

@section Styles{

}

@section Scripts{
    <script>
        function ShowDiscountDataSweetAlert() {
            const couponDiscountId = $('#txtDiscountIdSearch').val();
            const couponName = $('#DiscountName').text();
            const couponTagId = $('#DiscountTagId').text();
            const couponStartDate = $('#DiscountStartDate').text();
            const couponEndDate = $('#DiscountEndDate').text();
            const couponDiscount = $('#DiscountValue').text();

            Swal.fire({
                title: '打折優惠券資訊',
                html:
                    `<b>ID序號：</b> ${couponDiscountId}<br>` +
                    `<b>優惠券名稱：</b> ${couponName}<br>` +
                    `<b>適用對象：</b> ${couponTagId}<br>` +
                    `<b>開始日期：</b> ${couponStartDate}<br>` +
                    `<b>結束日期：</b> ${couponEndDate}<br>` +
                    `<b>折扣：</b> ${couponDiscount}`,
                icon: 'info',
                showDenyButton: true,
                denyButtonText: `修改`,
            }).then((result) => {
                if (result.isDenied) {
                    const editUrl = `@Url.Content("~/CouponsBackstageSettings/RebateEdit/")${couponDiscountId}`;
                    console.log(couponDiscountId);
                    location.href = editUrl;
                }
            })
        }

        function ShowRabateDataSweetAlert() {
            const couponRebateId = $('#txtRebateIdSearch').val();
            const couponName = $('#RebateName').text();
            const couponTagId = $('#RebateTagId').text();
            const couponStartDate = $('#RebateStartDate').text();
            const couponEndDate = $('#RebateEndDate').text();
            const couponCondition = $('#RebateCondition').text();
            const couponDiscount = $('#RebateDiscount').text();

            Swal.fire({
                title: '滿額送優惠券資訊',
                html:
                    `<b>ID序號：</b> ${couponRebateId}<br>` +
                    `<b>優惠券名稱：</b> ${couponName}<br>` +
                    `<b>適用對象：</b> ${couponTagId}<br>` +
                    `<b>開始日期：</b> ${couponStartDate}<br>` +
                    `<b>結束日期：</b> ${couponEndDate}<br>` +
                    `<b>消費門檻：<b/>${couponCondition}<br>` +
                    `<b>折扣：</b> ${couponDiscount}`,
                icon: 'info',
                showDenyButton: true,
                denyButtonText: `修改`,
            }).then((result) => {
                if (result.isDenied) {
                    const editUrl = `@Url.Content("~/CouponsBackstageSettings/RebateEdit/")${couponRebateId}`;
                    console.log(couponRebateId);
                    location.href = editUrl;
                }
            })
        }

        function NoIdDataSweetAlert() {
            swal.fire({
                title: '出了點問題...',
                text: '查無id，請再次確認id是否正確',
                icon: 'warning',
            });
        }

        function NoNameDataSweetAlert() {
            swal.fire({
                title: '出了點問題...',
                text: '查無名稱關鍵字，請再次確認名稱關鍵字是否正確',
                icon: 'warning',
            });
        }

        $(document).ready(function () {
            $("input[name='txtDiscountIdSearch']").on('input', function () {
                let txtSearchValue = $(this).val();

                //Debug
                //console.log("Input value:", txtSearchValue);

                if (txtSearchValue === '') {
                    //Debug
                    //console.log("Disable Button");

                    $('#btnDiscountSearch').prop("disabled", true);
                }
                else {
                    //Debug
                    //console.log("Enabling Button");

                    $('#btnDiscountSearch').prop("disabled", false);
                }
            });

            $("input[name='txtDiscountNameSearch']").on('input', function () {
                let txtSearchValue = $(this).val();

                if (txtSearchValue === '') {
                    $('#btnDiscountSearch').prop("disabled", true);
                }
                else {
                    $('#btnDiscountSearch').prop("disabled", false);
                }
            })

            $("input[name='txtRebateIdSearch']").on('input', function () {
                let txtSearchValue = $(this).val();

                //Debug
                //console.log("Input value:", txtSearchValue);

                if (txtSearchValue === '') {
                    //Debug
                    //console.log("Disable Button");

                    $('#btnRebateSearch').prop("disabled", true);
                }
                else {
                    //Debug
                    //console.log("Enabling Button");

                    $('#btnRebateSearch').prop("disabled", false);
                }
            })

            $("input[name='txtRebateNameSearch']").on('input', function () {
                let txtSearchValue = $(this).val();

                if (txtSearchValue === '') {
                    $('#btnRebateSearch').prop("disabled", true);
                }
                else {
                    $('#btnRebateSearch').prop("disabled", false);
                }
            })

            $('#txtDiscountIdSearch,#txtDiscountNameSearch,#txtRebateIdSearch,#txtRebateNameSearch').val('');
        });

        $('.btnClear').click(function(){
            $('#txtDiscountIdSearch,#txtDiscountNameSearch,#txtRebateIdSearch,#txtRebateNameSearch').val('');
        })

        $('#btnDiscountSearch').click(function () {
            const couponDiscountId = $('#txtDiscountIdSearch').val();
            const discountIdValue = $('#DiscountId').text();
            const searchKeyword = $('#txtDiscountNameSearch').val().trim().toLowerCase();
            const couponNameElements = $('#tabDiscount #DiscountName');
            const matchingCoupons = couponNameElements.filter((index, element) =>
                $(element).text().match(searchKeyword)
            );

            if (couponDiscountId) {
                if (couponDiscountId != discountIdValue) {
                    NoIdDataSweetAlert();
                }
                if (couponDiscountId === discountIdValue) {
                    ShowDiscountDataSweetAlert();
                }
                return;
            }

            if (searchKeyword) {
                if (matchingCoupons.length === 0) {
                    NoNameDataSweetAlert();
                } else {
                    let couponInfo = '';
                    matchingCoupons.each((index, element) => {

                        const couponId = $(element).closest('tr').find('#DiscountId').text();
                        const couponName = $(element).text();
                        const couponTagId = $(element).closest('tr').find('#DiscountTagId').text();
                        const couponStartDate = $(element).closest('tr').find('#DiscountStartDate').text();
                        const couponEndDate = $(element).closest('tr').find('#DiscountEndDate').text();
                        const couponDiscount = $(element).closest('tr').find('#DiscountValue').text();

                        console.log(couponId)
                        console.log(couponName)
                        console.log(couponTagId)
                        console.log(couponStartDate)
                        console.log(couponEndDate)
                        console.log(couponDiscount)

                        couponInfo += `<b>ID序號：</b> ${couponId}<br>` +
                            `<b>優惠券名稱：</b> ${couponName}<br>` +
                            `<b>適用對象：</b> ${couponTagId}<br>` +
                            `<b>開始日期：</b> ${couponStartDate}<br>` +
                            `<b>結束日期：</b> ${couponEndDate}<br>` +
                            `<b>折扣：</b> ${couponDiscount}<br><br>`;
                    });

                    Swal.fire({
                        title: '匹配的打折優惠券資訊',
                        html: couponInfo,
                        icon: 'info',
                    });
                }
            }
        });

        $('#btnRebateSearch').click(function () {
            const couponRebateId = $('#txtRebateIdSearch').val();
            const rebateIdValue = $('#RebateId').text();
            const searchKeyword = $('#txtRebateNameSearch').val();
            const couponNameElements = $('#tabRebate #RebateName');
            const matchingCoupons = couponNameElements.filter((index, element) =>
                $(element).text().match(searchKeyword)
            );

            console.log('Button clicked');
            console.log(couponRebateId);
            console.log(rebateIdValue);
            console.log(searchKeyword);
            console.log(couponNameElements);
            console.log(matchingCoupons);

            if (couponRebateId) {
                if (couponRebateId != rebateIdValue) {
                    NoIdDataSweetAlert();
                }
                else if (couponRebateId === rebateIdValue) {
                    ShowRabateDataSweetAlert();
                }
            }

            if (searchKeyword) {
                if (matchingCoupons.length === 0) {
                    NoNameDataSweetAlert();
                } else {
                    let couponInfo = '';
                    matchingCoupons.each((index, element) => {
                        const couponId = $(element).closest('tr').find('#RebateId').text();
                        const couponName = $(element).text();
                        const couponTagId = $(element).closest('tr').find('#RebateTagId').text();
                        const couponStartDate = $(element).closest('tr').find('#RebateStartDate').text();
                        const couponEndDate = $(element).closest('tr').find('#RebateEndDate').text();
                        const couponCondition = $(element).closest('tr').find('#RebateCondition').text();
                        const couponDiscount = $(element).closest('tr').find('#RebateDiscount').text();

                        couponInfo += `<b>ID序號：</b> ${couponId}<br>` +
                            `<b>優惠券名稱：</b> ${couponName}<br>` +
                            `<b>適用對象：</b> ${couponTagId}<br>` +
                            `<b>開始日期：</b> ${couponStartDate}<br>` +
                            `<b>結束日期：</b> ${couponEndDate}<br>` +
                            `<b>消費門檻：</b> ${couponCondition}<br>` +
                            `<b>折扣金額：</b> ${couponDiscount}<br><br>`;
                    });

                    Swal.fire({
                        title: '匹配的額度優惠券資訊',
                        html: couponInfo,
                        icon: 'info',
                    });
                }
            }
        });

        $('.btnEditDiscont').click(function () {
            const couponId = $(this).closest('tr').find('td:eq(0)').text();
            const editUrl = `@Url.Content("~/CouponsBackstageSettings/DiscountEdit/")${couponId}`;
            console.log(couponId);
            location.href = editUrl;
        })

        $('.btnEditRebate').click(function () {
            const couponId = $(this).closest('tr').find('td:eq(0)').text();
            const editUrl = `@Url.Content("~/CouponsBackstageSettings/RebateEdit/")${couponId}`;
            console.log(couponId);
            location.href = editUrl;
        })

        //刪除
        $('.btnDelete').click(function () {
            const couponId = $(this).closest('tr').find('td:eq(0)').text();
            const deleteUrl = `@Url.Content("~/api/apicoupon/")${couponId}`;

            Swal.fire({
                title: '確定要刪除優惠券？',
                text: '優惠券資料將被移除',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#FF2D2D',
                cancelButtonColor: '#019858',
                confirmButtonText: '刪除',
                cancelButtonText: '取消',
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: deleteUrl,
                        type: 'DELETE',
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader('X-CSRF-TOKEN', $('meta[name="csrf-token"]').attr('content'));
                        },
                        success: function (data) {
                            console.log(data);
                            Swal.fire('刪除成功', '資料已刪除', '確認').then(() => {
                                location.reload();
                            });
                        },
                        error: function (xhr, status, error) {
                            console.error(error);
                            Swal.fire('刪除失敗', '資料刪除失敗', '確認');
                        }
                    });
                }
            });
        })

        $('#btnCreate').click(function () {
            Swal.fire({
                title: '新增優惠券',
                text: '您想要新增哪種券',
                icon: 'question',
                showDenyButton: true,
                confirmButtonColor: '#FF2D2D',
                cancelButtonColor: '#019858',
                confirmButtonText: '打折券',
                denyButtonText: '滿額送',
            }).then((result) => {
                if (result.isConfirmed) {
                    location.href = `@Url.Content("~/CouponsBackstageSettings/DisCountCreate")`;
                }
                else if (result.isDenied) {
                    location.href = `@Url.Content("~/CouponsBackstageSettings/RebateCreate")`;
                }
            });
        })
    </script>
}