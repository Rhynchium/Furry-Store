@{
    ViewData["Title"] = "Index";
    Layout = "_BackstagePage";
}

<header class="container px-5 mt-5">

    <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">員工管理</li>
            <li class="breadcrumb-item active" aria-current="page">員工檢視</li>
        </ol>
    </nav>
</header>

<div class="container px-5">
    <div class="row gx-5">

        <div class="col-xxl-9 col-lg-6">

            <div class="contentbox bg-light rounded shadow p-2 mb-5">

                <div class="p-4">
                    <h2>員工檢視</h2>
                    <div class="d-flex justify-content-between">
                        <form>
                            <input type="text">
                            <button type="submit">
                                <i class="fa-solid fa-magnifying-glass"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <div class="tablebox">
                    <table class="table table-light table-striped table-hover">
                        <thead>
                            <tr>
                                <th>頭像</th>
                                <th>姓名</th>
                                <th>帳號名稱</th>
                                <th>權限</th>
                                <th>修改</th>
                                <th>刪除</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-between px-4 pt-4">
                    <button class="btn btn-primary shadow ms-auto me-2" id="btnAdd">新增員工</button>
                </div>

            </div>
        </div>

        <div class="col-xxl-3 col-lg-6">

            <div class=" bg-light rounded shadow p-2 mb-4">

                <h2 class="mt-4 ms-3">員工:大中天</h2>
                <figure class="p-4">
                    <img src="">
                </figure>

            </div>

            <div class=" bg-light rounded shadow p-2" id="data">
                <table class="table">
                    <thead>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-nowrap">姓名</td>
                            <td>大中天</td>
                        </tr>
                        <tr>
                            <td class="text-nowrap">帳號名稱</td>
                            <td>Big Middle Sky</td>
                        </tr>
                        <tr>
                            <td class="text-nowrap">電話</td>
                            <td>0933000000</td>
                        </tr>
                        <tr>
                            <td class="text-nowrap">Email</td>
                            <td>bms9487564651132131@yahoo.com.tw</td>
                        </tr>
                        <tr>
                            <td class="text-nowrap">權限</td>
                            <td>工讀生</td>
                        </tr>
                    </tbody>
                </table>

            </div>


        </div>

    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="edditModal" tabindex="-1" aria-labelledby="edditModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="edditModalLabel">title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createAndEdit" name="createAndEdit" data-index="-1">
                    <div class="mb-3">
                        <label for="name" class="col-form-label">姓名:</label>
                        <input type="text" class="form-control" id="name" name="EmployeeName">
                    </div>
                    <div class="mb-3">
                        <label for="account" class="col-form-label">帳號名稱:</label>
                        <input type="text" class="form-control" id="account" name="EmployeeAccount">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="col-form-label">密碼:</label>
                        <input type="text" class="form-control" id="password" name="EmployeePassword">
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="col-form-label">電話:</label>
                        <input type="text" class="form-control" id="phone" name="EmployeePhone">
                    </div>
                    <div class="mb-3">
                        <label for="email" class="col-form-label">Email:</label>
                        <input type="text" class="form-control" id="email" name="EmployeeEmail">
                    </div>
                    <div class="mb-3">
                        <label for="photo" class="col-form-label">頭像:</label>
                        <div class="my-3" id="imagePreviewDiv">
                            <img src="" id="imagePreview" />
                        </div>
                        <div class="input-group">
                            <input type="file" class="form-control rounded-end" id="avatar" name="avatar">
                            <button class="form-control btn border" type="button" id="deleteFile">x</button>
                        </div>
                    </div>

                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                <button type="button" class="btn btn-primary" id="btnSubmit">確認</button>
            </div>

        </div>
    </div>
</div>




@section Scripts{
    <script>

        //get Modal
        const myModal = new bootstrap.Modal(document.querySelector('.modal'))
        //會員資料
        let employeeData
        //抓取會員資料
        getEmployees()
        //新增會員按鈕
        $('#btnAdd').click(changeToInsertForm)
        //上傳圖片預覽
        const inputAvatar = document.querySelector('#avatar')
        inputAvatar.addEventListener('change', showOrHideImagePreview)
        //取消上傳圖片預覽
        $('#deleteFile').click(() => {
            inputAvatar.value = null
            showOrHideImagePreview()
        })

        /**functions**/

        //inputfile 顯示或隱藏預覽
        function showOrHideImagePreview() {
            if (inputAvatar.files && inputAvatar.files[0]) {
                const reader = new FileReader();

                reader.addEventListener('load', event => {
                    $('#imagePreview').attr('src', event.target.result)
                    $('#imagePreviewDiv').css('display', 'block')
                    $('#deleteFile').css('display', 'block')
                    $('#avatar').removeClass('rounded-end')
                })
                reader.readAsDataURL(inputAvatar.files[0]);
            }
            else {
                $('#imagePreviewDiv').css('display', 'none')
                $('#deleteFile').css('display', 'none')
                $('#avatar').addClass('rounded-end')
            }
        }

        //Ajax 抓取所有員工資料
        async function getEmployees() {
            const response = await fetch('@Url.Content("~/api/apiemployee")')

            if (!response.ok) return
            const data = await response.json()

            employeeData = data
            console.log(data)
            displayEmployees()
        }

        //Ajax 新增員工
        async function submitAdd() {
            const formData = new FormData(document.createAndEdit)

            const response = await fetch('@Url.Content("~/api/apiemployee")', {
                body: formData,
                method: 'POST'
            })

            if (response.status == 400) {
                console.log("輸入格式錯誤")
            }
            if (response.ok) {
                const data = await response.json()
                console.log(data)
                getEmployees()
                alert('輸入成功')
                myModal.hide()
            }
        }

        //Ajax 修改員工
        async function submitEdit() {
            const formData = new FormData(document.createAndEdit)
            const index = $('#createAndEdit').attr('data-index')
            const id = employeeData[index].employeeId

            const response = await fetch(`@Url.Content("~/api/apiemployee")/${id}`, {
                body: formData,
                method: 'PUT'
            })

            if (response.status == 400) {
                console.log("輸入格式錯誤")
            }

            if (response.ok) {
                const data = await response.json()
                console.log(data)
                getEmployees()
                alert('修改成功')
                myModal.hide()
            }
        }

        //Ajax 刪除員工
        async function deleteEmployee(event) {
            if (!confirm('是否確認刪除該員工')) return
            //TODO 輸入密碼確認  不可刪管理員
            const formData = new FormData(document.createAndEdit)
            const index = event.currentTarget.closest('tr').dataset.index
            const id = employeeData[index].employeeId

            const response = await fetch(`@Url.Content("~/api/apiemployee")/${id}`, { method: 'DELETE' })

            if (response.status == 400) {
                console.log("輸入格式錯誤")
            }

            if (response.ok) {
                const data = await response.json()
                console.log(data)
                getEmployees()
                alert('刪除成功')
                myModal.hide()
            }
        }

        //列出員工
        function displayEmployees() {
            const trs = employeeData.map((element, index) => {
                const imageName = (element.avatarName) ? element.avatarName : '_employeeDefault.jpg'
                return `<tr data-index="${index}" >
                    <td><img src="@Url.Content("~/uploads/employeeAvatar")/${imageName}" class="small-avatar"></td>
                    <td>${element.employeeName}</td>
                    <td>${element.employeeAccount}</td>
                    <td>${element.permission}</td>
                    <td><button class="btn btn-primary edit-btn">修改</button></td>
                    <td><button class="btn btn-danger delete-btn">刪除</button></td>
                    </tr>`
            })
            $('.tablebox').find('tbody').html(trs.join(''))
            $('.tablebox').find('.edit-btn').click(changeToEditForm)
            $('.tablebox').find('.delete-btn').click(deleteEmployee)
        }

        //調整為新增表單
        function changeToInsertForm() {
            const addForm = document.querySelector('#createAndEdit')
            addForm.reset()
            $('#account,#password').parent().css('display', 'block')
            $('#edditModalLabel').text('新增員工')
            showOrHideImagePreview()
            $('#createAndEdit').attr('data-index', '-1')
            myModal.show()
            $('#btnSubmit').off()
            $('#btnSubmit').click(submitAdd)
        }

        //調整為修改表單
        function changeToEditForm(event) {
            const editForm = document.querySelector('#createAndEdit')
            editForm.reset()
            $('#account,#password').parent().css('display', 'none')
            $('#edditModalLabel').text('修改員工資料')
            showOrHideImagePreview()
            const index = event.currentTarget.closest('tr').dataset.index
            $('#createAndEdit').attr('data-index', index)
            $('#name').val(employeeData[index].employeeName)
            $('#email').val(employeeData[index].employeeEmail)
            $('#phone').val(employeeData[index].employeePhone)

            myModal.show()
            $('#btnSubmit').off()
            $('#btnSubmit').click(submitEdit)
        }

    </script>
}


@section Styles{
    <style>

        .contentbox {
            height: 720px;
            overflow: auto;
        }


        .tablebox {
            height: 500px;
            overflow: auto;
        }

            .tablebox td img {
                height: 50px;
            }

            .tablebox td, th {
                vertical-align: middle;
            }

        figure {
            height: 250px;
            text-align: center;
        }

            figure img {
                max-width: 100%;
                max-height: 100%;
            }

        #data {
            height: 345px;
        }

            #data td {
                word-break: break-all;
                max-width: 200px;
            }

        #deleteFile {
            max-width: 50px;
            display: none;
        }

        #imagePreview {
            max-width: 250px;
        }

    </style>
}

