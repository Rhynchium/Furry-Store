@using MSIT147thGraduationTopic.Models.Dtos
@model (IEnumerable<CouponDto> listDiscount,IEnumerable<CouponDto> listRebate)
@{
    ViewData["Title"] = "可領取優惠券一覽表";
    var listA = Model.Item1;
    var listB = Model.Item2;
}
<head>
</head>
<body class="d-flex flex-column h-100">
    <main class="flex-shrink-0">
        <!-- Page Content-->
        <section class="py-5">
            <div class="text-center mb-5">
                <h1 class="fw-bolder">優惠券管理系統</h1>
                <p class="lead fw-normal text-muted mb-0"></p>
            </div>
            <div class="container px-5 my-5 ">
                <div class="row justify-content-center">                    
                    <ul class="nav nav-pills nav-fill" id="pills-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="pills-Discount-tab" data-bs-toggle="pill" data-bs-target="#pills-Discount" type="button" role="tab" aria-controls="pills-Discount" aria-selected="true">打折券</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-Rebate-tab" data-bs-toggle="pill" data-bs-target="#pills-Rebate" type="button" role="tab" aria-controls="pills-Rebate" aria-selected="false">滿額送</button>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pills-Discount" role="tabpanel" aria-labelledby="pills-Discount-tab" tabindex="0">
                    <div class="container px-5 my-5 ">
                        <div class="row justify-content-center">
                            <div class="col-md-3 mb-3">
                                <label for="txtDiscountIdSearch">打折券ID搜尋</label>
                                <input type="text" id="txtDiscountIdSearch" name="txtDiscountIdSearch" class="form-control" placeholder="請輸入ID" />
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="txtDiscountNameSearch">打折優惠券名稱關鍵字</label>
                                <input type="text" id="txtDiscountNameSearch" name="txtDiscountNameSearch" class="form-control" placeholder="請輸入名稱關鍵字" />
                            </div>
                            @*<div class="col-md-3 mb-3">
                                <label for="selectDiscountStatus">優惠券狀態</label>
                                <select id="selectDiscountStatus" name="selectDiscountStatus" class="form-select">
                                    <option value=""></option>
                                    <option value="all">全部</option>
                                    <option value="active">活動中</option>
                                    <option value="upcoming">未開始</option>
                                    <option value="expired">已結束</option>
                                </select>
                            </div>*@
                            <div class="col-md-1 mb-3">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-primary form-control" id="btnDiscountSearch" disabled>搜尋</button>
                            </div>
                            <div class="col-md-1 mb-3">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-secondary form-control btnClear" id="btnDiscountClear">清空</button>
                            </div>
                        </div>
                    </div>

                    <div class="container px-5 my-5">
                        <h2 class="text-center">折價優惠券</h2>
                        <table class="table table-dark table-hover" id="tabDiscount">
                            <thead>
                                <tr>
                                    <th scope="col">序號</th>
                                    <th scope="col">優惠券名稱</th>
                                    <th scope="col">適用對象</th>
                                    <th scope="col">活動開始日期</th>
                                    <th scope="col">活動結束日期</th>
                                    <th scope="col">打折優惠</th>
                                    <th scope="col">領取</th>
                                </tr>
                            </thead>
                            <tbody>
                                <form id="Discount" name="Discount" method="post" enctype="multipart/form-data" data-index="-1" class="need-validation row justify-content-center" novalidate>
                                    @{
                                        foreach (CouponDto c in Model.listDiscount)
                                        {
                                        <tr>
                                            <td id="DiscountId" scope="col">@c.CouponId</td>
                                            <td id="DiscountName" scope="col">@c.CouponName</td>
                                            <td id="DiscountTagId" scope="col">@c.CouponTagId</td>
                                            <td id="DiscountStartDate" scope="col">@c.CouponStartDate</td>
                                            <td id="DiscountEndDate" scope="col">@c.CouponEndDate</td>
                                            <td id="DiscountValue" scope="col">@c.CouponDiscount.ToString("#.##"+"折")</td>
                                            <td id="Discount" scope="col">
                                                <button type="button" id="btnReceiveDiscount_@c.CouponId" class="btn btn-success btnReceiveDiscount">
                                                    領取
                                                </button>
                                            </td>
                                        </tr>
                                        }
                                    }
                                </form>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="pills-Rebate" role="tabpanel" aria-labelledby="pills-Rebate-tab" tabindex="0">
                    <div class="container px-5 my-5 ">
                        <div class="row justify-content-center">
                            <div class="col-md-3 mb-3">
                                <label for="txtDiscountIdSearch">打折券ID搜尋</label>
                                <input type="text" id="txtDiscountIdSearch" name="txtDiscountIdSearch" class="form-control" placeholder="請輸入ID" />
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="txtDiscountNameSearch">打折優惠券名稱關鍵字</label>
                                <input type="text" id="txtDiscountNameSearch" name="txtDiscountNameSearch" class="form-control" placeholder="請輸入名稱關鍵字" />
                            </div>
                            @*<div class="col-md-3 mb-3">
                                <label for="selectRebateStatus">優惠券狀態</label>
                                <select id="selectRebateStatus" name="selectRebateStatus" class="form-select">
                                    <option value=""></option>
                                    <option value="all">全部</option>
                                    <option value="active">活動中</option>
                                    <option value="upcoming">未開始</option>
                                    <option value="expired">已結束</option>
                                </select>
                            </div>*@
                            <div class="col-md-1 mb-3">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-primary form-control" id="btnRebateSearch" disabled>搜尋</button>
                            </div>
                            <div class="col-md-1 mb-3">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-secondary form-control btnClear" id="btnRebateClear">清空</button>
                            </div>
                        </div>
                    </div>
                    <div class="container px-5 my-5">
                        <h2 class="text-center">滿額送優惠券</h2>
                        <table class="table table-dark table-hover" id="tabRebate">
                            <thead>
                                <tr>
                                    <th scope="col">序號</th>
                                    <th scope="col">優惠券名稱</th>
                                    <th scope="col">適用對象</th>
                                    <th scope="col">活動開始日期</th>
                                    <th scope="col">活動結束日期</th>
                                    <th scope="col">額度門檻</th>
                                    <th scope="col">折扣金額</th>
                                    <th scope="col">領取</th>
                                </tr>
                            </thead>

                            <tbody>
                                <form id="Rebate" name="Rebate" method="post" enctype="multipart/form-data" data-index="-1" class="need-validation row justify-content-center" novalidate>
                                    @{
                                        foreach (CouponDto c in Model.listRebate)
                                        {
                                        <tr>
                                            <td id="RebateId" scope="col">@c.CouponId</td>
                                            <td id="RebateName" scope="col">@c.CouponName</td>
                                            <td id="RebateTagId" scope="col">@c.CouponTagId</td>
                                            <td id="RebateStartDate" scope="col">@c.CouponStartDate</td>
                                            <td id="RebateEndDate" scope="col">@c.CouponEndDate</td>
                                            <td id="RebateCondition" scope="col">@c.CouponCondition.GetValueOrDefault().ToString("#.##")</td>
                                            <td id="RebateDiscount" scope="col">@c.CouponDiscount.ToString("#.##")</td>
                                            <td scope="col">
                                                <button type="button" id="btnReceiveRebate_@c.CouponId" class="btn btn-success btnReceiveRebate">
                                                    領取
                                                </button>
                                            </td>
                                        </tr>
                                        }
                                    }
                                </form>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="container px-5 my-5 text-center">
            </div>
        </section>
        <section class="py-5 bg-light">
            <div class="container px-5 my-5">
                <div class="row">
                    <div class="col">
                        <span class="text-muted">目前資料筆數:0/0</span>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <!-- Footer-->
    <footer class="bg-dark py-4 mt-auto">
        <div class="container px-5">
            <div class="row align-items-center justify-content-between flex-column flex-sm-row">
                <div class="col-auto"><div class="small m-0 text-white">Copyright &copy; Your Website 2023</div></div>
                <div class="col-auto">
                    <a class="link-light small" href="#!">Privacy</a>
                    <span class="text-white mx-1">&middot;</span>
                    <a class="link-light small" href="#!">Terms</a>
                    <span class="text-white mx-1">&middot;</span>
                    <a class="link-light small" href="#!">Contact</a>
                </div>
            </div>
        </div>
    </footer>
</body>

@section Styles{
    <style>
        #pills-tab {
            border-style: inset;
        }

        #pills-Discount-tab {
            margin: 5px;
        }

        #pills-Rebate-tab {
            margin: 5px;
        }
    </style>

}

@section Scripts{
    <script>
        //#region NoIdDataSweetAlert
        function NoIdDataSweetAlert() {
            swal.fire({
                title: '出了點問題...',
                text: '查無id，請再次確認id是否正確',
                icon: 'warning',
            });
        }
        //#endregion

        //#region NoNameDataSweetAlert
        function NoNameDataSweetAlert() {
            swal.fire({
                title: '出了點問題...',
                text: '查無名稱關鍵字，請再次確認名稱關鍵字是否正確',
                icon: 'warning',
            });
        }
        //#endregion

        //#region ConditionSweetAlert
        function ConditionSweetAlert() {
            Swal.fire({
                title: '出了點問題...',
                text: '沒有符合條件的資料',
                icon: 'info',
            })
        }
        //#endregion

        //#region 頁面開啟執行
        $(document).ready(function () {
            $("#txtDiscountIdSearch,#txtDiscountNameSearch,#selectDiscountStatus").on('input', function () {
                let txtSearchValue = $(this).val();

                if (txtSearchValue === '') {
                    $('#btnDiscountSearch').prop("disabled", true);
                }
                else {
                    $('#btnDiscountSearch').prop("disabled", false);
                }
            });

            $('#txtDiscountIdSearch,#txtDiscountNameSearch,#txtRebateIdSearch,#txtRebateNameSearch,#selectDiscountStatus,#selectRebateStatus').val('');
        });
        //#endregion

        //#region 清空按鈕
        $('.btnClear').click(function () {
            $('#txtDiscountIdSearch,#txtDiscountNameSearch,#txtRebateIdSearch,#txtRebateNameSearch,#selectDiscountStatus,#selectRebateStatus').val('');
        })
        //#endregion

        //#region 打折搜尋按鈕
        $('#btnDiscountSearch').click(function () {
            const couponDiscountId = $('#txtDiscountIdSearch').val();
            const discountIdValue = $('#DiscountId').text();
            const searchKeyword = $('#txtDiscountNameSearch').val().trim().toLowerCase();
            const couponNameElements = $('#tabDiscount #DiscountName');
            const matchingCoupons = couponNameElements.filter((index, element) =>
                $(element).text().match(searchKeyword)
            );
            //const now = new Date();
            //const currentTime = now.toLocaleString();

            if (couponDiscountId) {
                if (couponDiscountId != discountIdValue) {
                    NoIdDataSweetAlert();
                }
                if (couponDiscountId === discountIdValue) {
                    ShowDiscountDataSweetAlert();
                }
                return;
            }

            if (searchKeyword) {
                if (matchingCoupons.length === 0) {
                    NoNameDataSweetAlert();
                }
                else if (matchingCoupons.length === 0) {
                    ConditionSweetAlert();
                }
                else {
                    let couponInfo = '';
                    matchingCoupons.each((index, element) => {
                        const couponId = $(element).closest('tr').find('#DiscountId').text();
                        const couponName = $(element).text();
                        const couponTagId = $(element).closest('tr').find('#DiscountTagId').text();
                        const couponStartDate = $(element).closest('tr').find('#DiscountStartDate').text();
                        const couponEndDate = $(element).closest('tr').find('#DiscountEndDate').text();
                        const couponDiscount = $(element).closest('tr').find('#DiscountValue').text();

                        console.log(couponId)
                        console.log(couponName)
                        console.log(couponTagId)
                        console.log(couponStartDate)
                        console.log(couponEndDate)
                        console.log(couponDiscount)

                        couponInfo += `<b>ID序號：</b> ${couponId}<br>` +
                            `<b>優惠券名稱：</b> ${couponName}<br>` +
                            `<b>適用對象：</b> ${couponTagId}<br>` +
                            `<b>開始日期：</b> ${couponStartDate}<br>` +
                            `<b>結束日期：</b> ${couponEndDate}<br>` +
                            `<b>折扣：</b> ${couponDiscount}<br><br>`;
                    });



                    Swal.fire({
                        title: '匹配的打折優惠券資訊',
                        html: couponInfo,
                        icon: 'info',
                    });
                }
            }
        });
        //#endregion

        //#region 滿額送搜尋按鈕
        $('#btnRebateSearch').click(function () {
            const couponRebateId = $('#txtRebateIdSearch').val();
            const rebateIdValue = $('#RebateId').text();
            const searchKeyword = $('#txtRebateNameSearch').val();
            const couponNameElements = $('#tabRebate #RebateName');
            const matchingCoupons = couponNameElements.filter((index, element) =>
                $(element).text().match(searchKeyword)
            );

            console.log('Button clicked');
            console.log(couponRebateId);
            console.log(rebateIdValue);
            console.log(searchKeyword);
            console.log(couponNameElements);
            console.log(matchingCoupons);

            if (couponRebateId) {
                if (couponRebateId != rebateIdValue) {
                    NoIdDataSweetAlert();
                }
                else if (couponRebateId === rebateIdValue) {
                    ShowRabateDataSweetAlert();
                }
            }

            if (searchKeyword) {
                if (matchingCoupons.length === 0) {
                    NoNameDataSweetAlert();
                } else {
                    let couponInfo = '';
                    matchingCoupons.each((index, element) => {
                        const couponId = $(element).closest('tr').find('#RebateId').text();
                        const couponName = $(element).text();
                        const couponTagId = $(element).closest('tr').find('#RebateTagId').text();
                        const couponStartDate = $(element).closest('tr').find('#RebateStartDate').text();
                        const couponEndDate = $(element).closest('tr').find('#RebateEndDate').text();
                        const couponCondition = $(element).closest('tr').find('#RebateCondition').text();
                        const couponDiscount = $(element).closest('tr').find('#RebateDiscount').text();

                        couponInfo += `<b>ID序號：</b> ${couponId}<br>` +
                            `<b>優惠券名稱：</b> ${couponName}<br>` +
                            `<b>適用對象：</b> ${couponTagId}<br>` +
                            `<b>開始日期：</b> ${couponStartDate}<br>` +
                            `<b>結束日期：</b> ${couponEndDate}<br>` +
                            `<b>消費門檻：</b> ${couponCondition}<br>` +
                            `<b>折扣金額：</b> ${couponDiscount}<br><br>`;
                    });

                    Swal.fire({
                        title: '匹配的打折優惠券資訊',
                        html: couponInfo,
                        icon: 'info',
                    });
                }
            }
        });
        //#endregion

        //#region 領取打折券
        $('.btnReceiveDiscount').click(function () {
            const couponId = $(this).closest("tr").find('#DiscountId').text();

            $.post({
                url: "@Url.Content("~/api/apicoupon/couponreceive")",
                dataType: "json",
                data: JSON.stringify({ id: couponId }),
                contentType: "application/json",
                success: async result => {
                    await Swal.fire({
                        icon: 'success',
                        title: '成功',
                        text: '已領取優惠券',
                    });
                    window.location.reload();
                },
                error: err => { console.log(err) }
            })
        })
        //#endregion

        //#region 領取滿額送
        $('.btnReceiveRebate').click(function () {
            const couponId = $(this).closest("tr").find('#RebateId').text();

            $.post({
                url: "@Url.Content("~/api/apicoupon/couponreceive")",
                dataType: "json",
                data: JSON.stringify({ id: couponId }),
                contentType: "application/json",
                success: async result => {
                    await Swal.fire({
                        icon: 'success',
                        title: '成功',
                        text: '已領取優惠券',
                    });
                    window.location.reload();
                },
                error: err => { console.log(err) }
            })
        })
                                        //#endregion
    </script>
}