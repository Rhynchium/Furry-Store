@{
    ViewData["Title"] = "Compare";
    Layout = "_BackstagePage";
}


<div class="container mt-5">

    <div class="p-4 bg-white rounded shadow ">
        <h2 class="mt-2">商品比較圖</h2>
            <div class="p-5  " style="position: relative; height:600px; width:100%">
                <canvas id="trendChart" style="width:100% ; height:100%"></canvas>
            </div>


        <div class="row">

            <div class="col-lg-6">
                <div class="m-1 border rounded p-4" >


                    <div class="input-group">
                        <span class="input-group-text bg-white">請選擇對比商品</span>
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">商品名稱</button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">商品名稱</a></li>
                            <li><a class="dropdown-item" href="#">規格名稱</a></li>
                            <li><a class="dropdown-item" href="#">商品ID</a></li>
                            <li><a class="dropdown-item" href="#">規格ID</a></li>
                        </ul>
                        <input type="text" class="form-control" aria-label="Text input with 2 dropdown buttons">
                        <button class="btn btn-dark px-4" type="button">確認</button>
                    </div>


                    <div class="p-5  " style="position: relative; height:600px; width:100%">
                        <canvas id="none"></canvas>
                    </div>


                </div>
            </div>


            <div class="col-lg-6">
                <div class="m-1 border rounded p-4" >

                    <div class="input-group">
                        <span class="input-group-text bg-white">請選擇對比商品</span>
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">商品名稱</button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">商品名稱</a></li>
                            <li><a class="dropdown-item" href="#">規格名稱</a></li>
                            <li><a class="dropdown-item" href="#">商品ID</a></li>
                            <li><a class="dropdown-item" href="#">規格ID</a></li>
                        </ul>
                        <input type="text" class="form-control" aria-label="Text input with 2 dropdown buttons">
                        <button class="btn btn-dark px-4" type="button" id="test">確認</button>
                    </div>


                    <div class="p-5  " style="position: relative; height:600px; width:100%">
                        <canvas id="none"></canvas>
                    </div>


                </div>


            </div>



        </div>





    </div>



</div>



@section Scripts{
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const inputTimeInterval = document.getElementById('inputTimeInterval')
        let measurement = 'category' // category animal brand
        let classification = 'quantity' // quantity profit
        let timeUnit = 'week' // month week
        let timeIntervals = 12
        let trendData


        $('#btnAccordingToCategory').click(e => {
            measurement = 'category'
            btnDisplay(e.currentTarget)
        })
        $('#btnAccordingToPet').click(e => {
            measurement = 'animal'
            btnDisplay(e.currentTarget)
        })
        $('#btnAccordingToBrand').click(e => {
            measurement = 'brand'
            btnDisplay(e.currentTarget)
        })
        function btnDisplay(element) {
            $(element).addClass('btn-primary').removeClass('btn-outline-primary')
                .siblings().removeClass('btn-primary').addClass('btn-outline-primary')
            refreshTrendData()
        }

        //btnMonth
        $('#btnMonth').click(e => {
            timeUnit = 'month'
            $('#spanTimeUnit').text('月')
            refreshTrendData()
        })
        //btnWeek
        $('#btnWeek').click(e => {
            timeUnit = 'week'
            $('#spanTimeUnit').text('星期')
            refreshTrendData()
        })

        //inputTimeInterval
        

        //btnSubTime
        $('#btnSubTime').click(e => {
            timeIntervals--
            validTimeIntervals()
            inputTimeInterval.value = timeIntervals
            displayTrendData()
        })
        //btnAddTime
        $('#btnAddTime').click(e => {
            timeIntervals++
            validTimeIntervals()
            inputTimeInterval.value = timeIntervals
            displayTrendData()
        })

        function validTimeIntervals() {
            if (isNaN(+timeIntervals)) timeIntervals = 6
            timeIntervals = Math.max(timeIntervals, 2)
            timeIntervals = Math.min(timeIntervals, 36)
        }

        //selectMeasureUnit
        $('#selectMeasureUnit').change(e => {
            const val = $(e.currentTarget).val()
            console.log(val)
            classification = val
            refreshTrendData()
        })

        //trendChart
        const ctxTrend = document.getElementById('trendChart').getContext('2d');
        const trendChart = new Chart(ctxTrend, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '',
                    data: [],
                    borderWidth: 2
                }]
            },
            options: {
                responsive:true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        })

        //window.onresize = e => {
        //    console.log('resize')
        //    const canva = document.getElementById('trendChart')
        //    canva.height = canva.parentElement.clientHeight
        //    canva.width = canva.parentElement.clientWidth
        //    trendChart.resize()
        //}

        //刷新趨勢data
        refreshTrendData()
        async function refreshTrendData() {
            showLoadingBox()
            await getTrendData()
            const data = JSON.parse(JSON.stringify(trendData))
            trendChart.data.datasets = data.dataSets.map(set => {
                set.data = set.data.slice(36 - timeIntervals)
                return set
            })
            trendChart.data.labels = data.labels.slice(36 - timeIntervals)
            trendChart.update()
            hideLoadingBox()
        }

        //顯示趨勢data
        async function displayTrendData() {
            const data = JSON.parse(JSON.stringify(trendData))
            trendChart.data.datasets = data.dataSets.map(set => {
                set.data = set.data.slice(36 - timeIntervals)
                return set
            })
            trendChart.data.labels = data.labels.slice(36 - timeIntervals)
            trendChart.update()
        }

        //取得趨勢data
        getTrendData()
        async function getTrendData() {
            const response = await fetch(`${ROOT}/api/apistatistic/saletrend?` +
                `measurement=${measurement}&classification=${classification}&timeUnit=${timeUnit}&timeIntervals=36`)
            const data = await response.json()
            console.log(data)
            trendData = data
        }


    </script>
}

@section Styles{
    <style>
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }

    </style>
}

